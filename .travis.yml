sudo: false
language: node_js
node_js:
  - '10.18.0'

cache:
  directories:
    - node_modules
    - /home/travis/.rvm/
    - vendor/bundle

env:
  - TASK=validate-build
  - TASK=lint
  - TASK=test-ci
  - TASK=fossa
  - TASK=e2e CI_NODE_TOTAL=4 CI_NODE_INDEX=0
  - TASK=e2e CI_NODE_TOTAL=4 CI_NODE_INDEX=1
  - TASK=e2e CI_NODE_TOTAL=4 CI_NODE_INDEX=2
  - TASK=e2e CI_NODE_TOTAL=4 CI_NODE_INDEX=3
  - TASK=audit

before_install:
  - curl -u "$ARTIFACTORY_USERNAME:$ARTIFACTORY_API_KEY" https://zdrepo.jfrog.io/zdrepo/api/npm/npm/auth/zendesk >> ~/.npmrc
  - npm i -g npm@6.13.4

install:
  - mkdir dist
  - npm set progress=false && npm install
  - npm run build:version:generate

script:
  - |
    download_translations() {
      rvm install 2.5.5
      bundle install --jobs=3 --retry=3 --path=vendor/bundle
      npm run build-setup:prod
    }
    if [[ "$TASK" == "fossa" ]]
    then
        echo "Starting Fossa open source scan";
        ./script/run_fossa.sh;
    elif [[ "$TASK" == "audit" ]]
    then
        echo "Starting npm audit";
        audit-ci --critical
    elif [[ "$TASK" == "e2e" ]]
    then
        echo "Starting end-to-end tests";
        download_translations
        export JEST_TESTS=$(SKIP_PARALLEL=1 npm run e2e --  --listTests --json)
        npm run e2e:ci
    elif [[ "$TASK" == "test-ci" ]]
    then
        echo "Starting unit and integration tests";
        download_translations
        npm run test:ci
    elif [[ "$TASK" == "validate-build" ]]
    then
        echo "Validating prod builds";
        download_translations
        bundle exec ruby ./script/validate_i18n.rb || travis_terminate 1
        npm run build:validate
    else
        echo "Running task";
        npm run $TASK;
    fi
branches:
  only:
    - master
    - /^feature.*$/
    - Code_Freeze

notifications:
  email: false
  webhooks: https://samson.zende.sk/integrations/travis/b127503546dbc459293e47fbae026af2
  slack:
    secure: pHyAv7xNsAF1mdz9o4joPqvfe2mM9q5ttvN0GqJYWRfQIUlcwvMQnyRZMSrsRRAFh5nqRayXOMuLa/wE1MyqAug5nK5yPEgZQRjLDeXeHXv3vOLlcgcHJcrrqyCGkLRnFP0LDintwpJIIzNkcr+qSJPQ7QjPjZd5Rf0zfvfTQwo=
